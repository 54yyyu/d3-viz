# tfmodisco-lite-js

[![JavaScript](https://img.shields.io/badge/JavaScript-ES6+-yellow.svg)](https://www.javascript.com/)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)

A JavaScript port of the [TF-MoDISco algorithm](https://github.com/kundajelab/tfmodisco) for motif discovery from importance scores in biological sequences.

## Overview

TF-MoDISco (Transcription Factor Motif Discovery from Importance Scores) is an algorithm for discovering motifs from attribution scores generated by machine learning models on biological sequences. This JavaScript implementation provides:

- **Seqlet extraction** - Find important subsequences from attribution scores
- **Gapped k-mer similarity** - Fast similarity calculation with alignment 
- **Leiden clustering** - Community detection for grouping similar seqlets
- **Pattern formation** - Create Position Weight Matrices (PWMs) from clusters
- **Pattern merging** - Combine redundant patterns automatically

## Installation

### Node.js
```bash
npm install tfmodisco-lite-js
```

### Browser
```html
<script src="tfmodisco-lite.js"></script>
```

## Quick Start

### Basic Usage

```javascript
// Import the library (Node.js)
const TFModiscoLite = require('tfmodisco-lite-js');

// Or use in browser
// const TFModiscoLite = window.TFModiscoLite;

const tfm = new TFModiscoLite();

// Example: One-hot encode DNA sequences
const sequences = [
    "ACGTACGTACGT",
    "TTTTAAAACCCC", 
    "GCTAGCTAGCTA"
];

const oneHot = sequences.map(seq => tfm.oneHotEncode(seq));
console.log('Encoded sequences:', oneHot[0]); // [[1,0,0,0,1,0,0,0,1,0,0,0], ...]
```

### Complete TF-MoDISco Analysis

```javascript
const tfm = new TFModiscoLite();

// Your data: one-hot encoded sequences [samples x positions x 4]
const oneHot = [
    [[1,0,0,0], [0,1,0,0], [0,0,1,0], [0,0,0,1]], // ACGT
    [[0,0,0,1], [0,0,0,1], [1,0,0,0], [1,0,0,0]]  // TTAA
];

// Attribution scores from your ML model [samples x positions x 4]
const hypotheticalContribs = [
    [[0.8,0.1,0.05,0.05], [0.1,0.7,0.1,0.1], [0.05,0.1,0.8,0.05], [0.1,0.1,0.1,0.7]],
    [[0.2,0.2,0.2,0.4], [0.3,0.3,0.3,0.1], [0.9,0.05,0.03,0.02], [0.8,0.1,0.05,0.05]]
];

// Run TF-MoDISco analysis
const results = tfm.tfmodisco(oneHot, hypotheticalContribs, {
    slidingWindowSize: 15,
    targetSeqletFDR: 0.2,
    verbose: true
});

console.log(`Found ${results.posPatterns.length} positive patterns`);
console.log(`Found ${results.negPatterns.length} negative patterns`);

// Access pattern information
results.posPatterns.forEach((pattern, i) => {
    console.log(`Pattern ${i}: ${pattern.size} seqlets`);
    console.log('PWM:', pattern.seqletSet.sequence); // 4 x length matrix
});
```

### Working with Real Data

```javascript
// Load your trained model's attribution scores
// This could come from methods like:
// - Integrated Gradients
// - SHAP values  
// - GradCAM
// - DeepLIFT

const attributionData = loadAttributionScores(); // Your function
const sequenceData = loadSequences(); // Your function

const tfm = new TFModiscoLite();

// Encode sequences
const oneHot = sequenceData.map(seq => tfm.oneHotEncode(seq));

// Run analysis with custom parameters
const patterns = tfm.tfmodisco(oneHot, attributionData, {
    slidingWindowSize: 21,
    flankSize: 10,
    targetSeqletFDR: 0.15,
    minMetaclusterSize: 50,
    verbose: true
});

// Export patterns for downstream analysis
patterns.posPatterns.forEach(pattern => {
    const pwm = pattern.seqletSet.sequence;
    const consensus = tfm.icWeightedConsensus(pwm);
    console.log(`Motif consensus: ${consensus}`);
});
```

## API Reference

### Constructor

#### `new TFModiscoLite()`
Create a new TF-MoDISco instance.

### Main Analysis Method  

#### `tfmodisco(oneHot, hypotheticalContribs, options)`
Run the complete TF-MoDISco algorithm.

**Parameters:**
- `oneHot` (Array): One-hot encoded sequences [samples x positions x 4]
- `hypotheticalContribs` (Array): Attribution scores [samples x positions x 4] 
- `options` (Object): Algorithm parameters (optional)

**Options:**
- `slidingWindowSize` (number): Window size for seqlet extraction (default: 21)
- `flankSize` (number): Flanking region size (default: 10)
- `targetSeqletFDR` (number): False discovery rate for seqlet calling (default: 0.2)
- `minMetaclusterSize` (number): Minimum cluster size (default: 100)
- `maxSeqletsPerMetacluster` (number): Maximum seqlets per cluster (default: 20000)
- `verbose` (boolean): Enable logging (default: false)

**Returns:** Object with `posPatterns` and `negPatterns` arrays

### Utility Methods

#### `oneHotEncode(sequence, alphabet)`
Convert DNA sequence to one-hot encoding.

**Parameters:**
- `sequence` (string): DNA sequence
- `alphabet` (Array): Base alphabet (default: ['A','C','G','T'])

**Returns:** 2D array [4 x length]

#### `computeIC(pwm)`
Calculate information content profile from PWM.

**Parameters:** 
- `pwm` (Array): Position weight matrix [4 x length]

**Returns:** Array of information content values

#### `icWeightedConsensus(pwm)`
Generate consensus sequence weighted by information content.

**Parameters:**
- `pwm` (Array): Position weight matrix [4 x length]

**Returns:** Consensus sequence string

### Pattern Object Structure

Each pattern object contains:

```javascript
{
    seqlets: [...],           // Array of contributing seqlets
    seqletSet: {...},         // SeqletSet with PWM and matrices
    size: 150,                // Number of seqlets
    id: "pattern_0",          // Pattern identifier
    coreStart: 5,             // Start of high-IC region
    coreEnd: 15               // End of high-IC region
}
```

## Algorithm Details

The TF-MoDISco algorithm consists of several steps:

1. **Seqlet Extraction**: Identify subsequences with high attribution scores
2. **Similarity Computation**: Calculate cosine and Jaccard similarities 
3. **Clustering**: Group similar seqlets using Leiden algorithm
4. **Pattern Formation**: Create PWMs from seqlet clusters
5. **Pattern Merging**: Combine redundant patterns
6. **Refinement**: Trim patterns to high-information regions

## Performance Notes

This JavaScript implementation provides:

- **Pure JavaScript**: No external dependencies
- **Memory efficient**: Streaming and sparse matrix operations
- **Browser compatible**: Works in both Node.js and browsers
- **Reasonable performance**: Suitable for moderate-scale analyses

For extremely large datasets (>100k sequences), consider:
- Subsampling sequences before analysis
- Using the original Python implementation with numba acceleration
- Running analysis in web workers for browser applications

## Examples

### Example 1: TFBS Discovery

```javascript
// Simulate ChIP-seq peak sequences with attribution scores
const peakSequences = [
    "ATCGATCGATCGATCG",
    "GCTAGCTAGCTAGCTA", 
    "TTTTAAAACCCCGGGG"
];

const attributionScores = simulateAttributions(peakSequences);
const oneHot = peakSequences.map(seq => tfm.oneHotEncode(seq));

const motifs = tfm.tfmodisco(oneHot, attributionScores);
console.log(`Discovered ${motifs.posPatterns.length} motifs`);
```

### Example 2: Single Cell Analysis

```javascript
// Process single cell accessibility data
const scATACData = loadSingleCellData();
const modelScores = runDeepModel(scATACData);

const patterns = tfm.tfmodisco(scATACData.sequences, modelScores, {
    slidingWindowSize: 15,
    minMetaclusterSize: 20,  // Smaller for sparse data
    verbose: true
});
```

## Comparison to Python Version

| Feature | JavaScript | Python |
|---------|------------|---------|
| Seqlet extraction | ✅ | ✅ |
| Clustering | ✅ (Leiden) | ✅ (Leiden) |  
| Pattern formation | ✅ | ✅ |
| Performance | Good | Excellent (numba) |
| Browser support | ✅ | ❌ |
| Dependencies | None | numpy, pandas, etc. |

## Contributing

This is a JavaScript port of the original [TF-MoDISco algorithm](https://github.com/kundajelab/tfmodisco). Please consider:

1. Contributing to the original Python implementation
2. Reporting JavaScript-specific issues here
3. Submitting pull requests for improvements

## License

MIT License - see LICENSE file for details.

## Citation  

If you use this library, please cite the original TF-MoDISco paper:

```
@article{shrikumar2018technical,
  title={Technical note on transcription factor motif discovery from importance scores (tf-modisco) version 0.5.6.5},  
  author={Shrikumar, Avanti and Greenside, Peyton and Kundaje, Anshul},
  journal={arXiv preprint arXiv:1811.00416},
  year={2018}
}
```

## Links

- [Original TF-MoDISco](https://github.com/kundajelab/tfmodisco)
- [TF-MoDISco Paper](https://arxiv.org/abs/1811.00416)
- [Integrated Gradients](https://arxiv.org/abs/1703.01365)